<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lumicell Cavity Mapper Prototype</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <main class="app-shell">
      <section id="baseline-page" class="page active baseline-layout">
        <header class="workflow-header cardless">
          <button class="menu-btn" aria-label="Menu">☰</button>
          <div class="workflow-steps">
            <div class="step done"><span>1</span><small>Calibrate bright plate</small></div>
            <div class="step done"><span>2</span><small>Calibrate dark plate</small></div>
            <div class="step done"><span>3</span><small>Apply sterile cover</small></div>
            <div class="step done"><span>4</span><small>Prepare for imaging</small></div>
            <div class="step active"><span>5</span><small>Establish baseline</small></div>
          </div>
          <label class="probe-toggle">Probe Light
            <input id="probe-toggle" type="checkbox" disabled />
            <span>mocked</span>
          </label>
        </header>

        <aside class="baseline-sidebar">
          <h2>Establish baseline</h2>
          <ul>
            <li>Upload 6 baseline images (PNG/JPG/TIF).</li>
            <li>Assign each upload to a unique orientation.</li>
            <li>Drag to center and wheel to zoom inside the circular field.</li>
            <li>Average intensity is computed inside the circular field.</li>
            <li>When all six orientations are assigned, continue to live cube map.</li>
          </ul>

          <div class="capture-controls">
            <label for="image-upload">Upload baseline images (up to 6)</label>
            <input id="image-upload" type="file" accept="image/*,.tif,.tiff" multiple />
            <button id="build-cube-btn" disabled>Build cavity cube from uploads</button>
            <p id="capture-status" class="status"></p>
          </div>

          <div id="capture-grid" class="capture-grid"></div>
        </aside>

        <section class="baseline-viewer">
          <div class="viewer-stage">
            <canvas id="preview-canvas" width="900" height="900"></canvas>
            <p class="viewer-help">Drag to center • Mouse wheel to zoom</p>
          </div>
          <p class="meta">Selected image circular avg intensity: <span id="latest-average">--</span></p>
        </section>
      </section>

      <section id="live-page" class="page">
        <div class="live-layout">
          <aside class="card model-overlay-card">
            <div class="model-header">
              <h3>Cavity Map Model</h3>
              <label class="view-toggle" for="view-mode-toggle">
                <input id="view-mode-toggle" type="checkbox" />
                <span class="track"><span class="thumb"></span></span>
                <span id="view-mode-label">Collapsed cube</span>
              </label>
            </div>
            <p>Drag to rotate. Toggle between collapsed cube and exploded cavity view with central cavity opening.</p>
            <div id="model-scene" class="model-scene">
              <div id="cavity-model" class="cavity-model">
                <div class="face face-front" data-face="inferior"></div>
                <div class="face face-back" data-face="posterior"></div>
                <div class="face face-right" data-face="medial"></div>
                <div class="face face-left" data-face="lateral"></div>
                <div class="face face-top" data-face="superior"></div>
                <div class="face face-bottom" data-face="anterior"></div>
                <div class="cavity-core" aria-hidden="true"></div>
              </div>
            </div>
            <div class="heatmap-legend" aria-label="Jet heatmap scale">
              <span id="heatmap-min">Low</span>
              <div class="heatmap-bar"></div>
              <span id="heatmap-max">High</span>
            </div>
            <section class="patient-panel">
              <h4>Patient orientation view</h4>
              <p>Click the cavity on the chest to expand the orientation map.</p>
              <div class="patient-figure-wrap">
                <svg class="patient-figure" viewBox="0 0 260 430" aria-hidden="true">
                  <ellipse cx="130" cy="410" rx="86" ry="8" class="shadow" />
                  <path d="M130 24c16 0 29 13 29 29 0 9-4 17-10 22v9h-38v-9c-6-5-10-13-10-22 0-16 13-29 29-29z" />
                  <path d="M111 70c5-6 11-10 19-10s14 4 19 10l8 20c12 3 20 11 20 24v36l11 43c2 10 3 18 0 26l-8 20c-4 10-5 18-5 27v61c0 12-7 19-18 19-9 0-16-6-17-16l-4-54-4 54c-1 10-8 16-17 16-11 0-18-7-18-19v-61c0-9-1-17-5-27l-8-20c-3-8-2-16 0-26l11-43v-36c0-13 8-21 20-24l8-20z" />
                  <path d="M83 165l-9 56-13 34c-3 9 2 18 11 21 9 3 18-2 21-11l12-31 10-48z" />
                  <path d="M177 165l9 56 13 34c3 9-2 18-11 21-9 3-18-2-21-11l-12-31-10-48z" />
                  <path d="M110 348l-12 56c-2 8 3 16 11 18 8 2 16-3 18-11l6-58z" />
                  <path d="M150 348l12 56c2 8-3 16-11 18-8 2-16-3-18-11l-6-58z" />
                </svg>
                <button id="patient-cavity-btn" class="patient-cavity-btn" type="button" aria-label="Open cavity orientation map"></button>
              </div>
            </section>
            <ul id="cube-legend" class="cube-legend"></ul>
          </aside>
        </div>
      </section>
    </main>


    <div id="cavity-map-modal" class="cavity-modal" hidden>
      <div class="cavity-modal-card" role="dialog" aria-modal="true" aria-label="Expanded cavity orientation map">
        <button id="close-cavity-modal" class="close-cavity-modal" type="button" aria-label="Close">×</button>
        <h4>Expanded cavity orientation map</h4>
        <div id="cavity-wheel-large" class="cavity-wheel cavity-wheel-large">
          <div class="cavity-hole"></div>
          <span class="wheel-label label-superior">superior</span>
          <span class="wheel-label label-lateral">lateral</span>
          <span class="wheel-label label-inferior">inferior</span>
          <span class="wheel-label label-medial">medial</span>
          <span class="wheel-label label-posterior-center">posterior</span>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.min.js"></script>
    <script src="app.js"></script>
  </body>
</html>
